<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Campañas Viamar</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCdH7SDkxWHKRnCIiueEkr5PUOOqmZO_1k",
  authDomain: "campanas-viamar.firebaseapp.com",
  projectId: "campanas-viamar",
  storageBucket: "campanas-viamar.firebasestorage.app",
  messagingSenderId: "165190287506",
  appId: "1:165190287506:web:7fc6f39401a136d4a7e64b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>;
const Copy = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
const Save = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
const Calendar = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
const X = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

const App = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [dailyUpdates, setDailyUpdates] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [editingCampaign, setEditingCampaign] = useState(null);
    const [todayStatus, setTodayStatus] = useState({});
    const [updateDate, setUpdateDate] = useState(new Date().toISOString().split('T')[0]);
    const [selectedCampaign, setSelectedCampaign] = useState('all');
    const [selectedUpdateCampaigns, setSelectedUpdateCampaigns] = useState([]);
    const [historyFilterPlatform, setHistoryFilterPlatform] = useState('all');
    const [historyFilterDateFrom, setHistoryFilterDateFrom] = useState('');
    const [historyFilterDateTo, setHistoryFilterDateTo] = useState('');
    const [selectedMonth, setSelectedMonth] = useState('2026-01');
    const [formData, setFormData] = useState({ name: '', platform: '', objective: '', plannedCPL: '' });
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('estadisticas');

    useEffect(() => {
        const unsubscribeCampaigns = db.collection('campaigns').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCampaigns(data);
            setLoading(false);
        });

        const unsubscribeUpdates = db.collection('dailyUpdates').orderBy('date', 'desc').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDailyUpdates(data);
        });

        return () => {
            unsubscribeCampaigns();
            unsubscribeUpdates();
        };
    }, []);

    useEffect(() => {
        if (campaigns.length > 0 && selectedUpdateCampaigns.length === 0) {
            setSelectedUpdateCampaigns(campaigns.map(c => c.id.toString()));
        }
    }, [campaigns]);

    const handleAddCampaign = async () => {
        if (formData.name && formData.objective && formData.platform) {
            await db.collection('campaigns').add({
                ...formData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setFormData({ name: '', platform: '', objective: '', plannedCPL: '' });
            setShowForm(false);
        }
    };

    const handleEditCampaign = async () => {
        if (editingCampaign) {
            await db.collection('campaigns').doc(editingCampaign.id).update({
                name: editingCampaign.name,
                platform: editingCampaign.platform,
                objective: editingCampaign.objective,
                plannedCPL: editingCampaign.plannedCPL
            });
            setEditingCampaign(null);
        }
    };

    const handleDeleteCampaign = async (id) => {
        if (confirm('¿Eliminar campaña?')) {
            await db.collection('campaigns').doc(id).delete();
        }
    };

    const handleStatusChange = (id, field, value) => {
        setTodayStatus({ ...todayStatus, [id]: { ...todayStatus[id], [field]: value } });
    };

    const handleSaveDailyStatus = async () => {
        const hasData = Object.keys(todayStatus).some(id => todayStatus[id]?.currentLeads || todayStatus[id]?.currentCPL || todayStatus[id]?.comment);
        if (!hasData) return alert('❌ Agrega datos primero');

        const campaignsWithData = [];
        
        campaigns.forEach(c => {
            const status = todayStatus[c.id];
            if (status && (status.currentLeads || status.currentCPL || status.comment)) {
                campaignsWithData.push({
                    campaignId: c.id,
                    name: c.name,
                    platform: c.platform,
                    objective: c.objective,
                    plannedCPL: c.plannedCPL,
                    currentLeads: status.currentLeads || '',
                    currentCPL: status.currentCPL || '',
                    comment: status.comment || ''
                });
            }
        });

        if (campaignsWithData.length === 0) {
            return alert('❌ No hay campañas con datos para guardar');
        }

        try {
            const existing = await db.collection('dailyUpdates').where('date', '==', updateDate).get();
            
            if (!existing.empty) {
                const existingDoc = existing.docs[0];
                const existingData = existingDoc.data();
                const existingCampaigns = existingData.campaigns || [];
