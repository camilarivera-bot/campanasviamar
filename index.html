<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Campa√±as Viamar</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCdH7SDkxWHKRnCIiueEkr5PUOOqmZO_1k",
  authDomain: "campanas-viamar.firebaseapp.com",
  projectId: "campanas-viamar",
  storageBucket: "campanas-viamar.firebasestorage.app",
  messagingSenderId: "165190287506",
  appId: "1:165190287506:web:7fc6f39401a136d4a7e64b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>;
const Copy = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
const Save = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
const Calendar = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
const X = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

const App = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [dailyUpdates, setDailyUpdates] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [editingCampaign, setEditingCampaign] = useState(null);
    const [todayStatus, setTodayStatus] = useState({});
    const [updateDate, setUpdateDate] = useState(new Date().toISOString().split('T')[0]);
    const [selectedCampaign, setSelectedCampaign] = useState('all');
    const [selectedUpdateCampaigns, setSelectedUpdateCampaigns] = useState([]);
    const [historyFilterPlatform, setHistoryFilterPlatform] = useState('all');
    const [historyFilterDateFrom, setHistoryFilterDateFrom] = useState('');
    const [historyFilterDateTo, setHistoryFilterDateTo] = useState('');
    const [selectedMonth, setSelectedMonth] = useState('2026-01');
    const [formData, setFormData] = useState({ name: '', platform: '', objective: '', plannedCPL: '' });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsubscribeCampaigns = db.collection('campaigns').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCampaigns(data);
            setLoading(false);
        });

        const unsubscribeUpdates = db.collection('dailyUpdates').orderBy('date', 'desc').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDailyUpdates(data);
        });

        return () => {
            unsubscribeCampaigns();
            unsubscribeUpdates();
        };
    }, []);

    useEffect(() => {
        if (campaigns.length > 0 && selectedUpdateCampaigns.length === 0) {
            setSelectedUpdateCampaigns(campaigns.map(c => c.id.toString()));
        }
    }, [campaigns]);

    const handleAddCampaign = async () => {
        if (formData.name && formData.objective && formData.platform) {
            await db.collection('campaigns').add({
                ...formData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setFormData({ name: '', platform: '', objective: '', plannedCPL: '' });
            setShowForm(false);
        }
    };

    const handleEditCampaign = async () => {
        if (editingCampaign) {
            await db.collection('campaigns').doc(editingCampaign.id).update({
                name: editingCampaign.name,
                platform: editingCampaign.platform,
                objective: editingCampaign.objective,
                plannedCPL: editingCampaign.plannedCPL
            });
            setEditingCampaign(null);
        }
    };

    const handleDeleteCampaign = async (id) => {
        if (confirm('¬øEliminar campa√±a?')) {
            await db.collection('campaigns').doc(id).delete();
        }
    };

    const handleStatusChange = (id, field, value) => {
        setTodayStatus({ ...todayStatus, [id]: { ...todayStatus[id], [field]: value } });
    };

    const handleSaveDailyStatus = async () => {
        const hasData = Object.keys(todayStatus).some(id => todayStatus[id]?.currentLeads || todayStatus[id]?.currentCPL || todayStatus[id]?.comment);
        if (!hasData) return alert('‚ùå Agrega datos primero');

        // Construir el array de campa√±as con datos
        const campaignsWithData = [];
        
        campaigns.forEach(c => {
            const status = todayStatus[c.id];
            if (status && (status.currentLeads || status.currentCPL || status.comment)) {
                campaignsWithData.push({
                    campaignId: c.id,
                    name: c.name,
                    platform: c.platform,
                    objective: c.objective,
                    plannedCPL: c.plannedCPL,
                    currentLeads: status.currentLeads || '',
                    currentCPL: status.currentCPL || '',
                    comment: status.comment || ''
                });
            }
        });

        if (campaignsWithData.length === 0) {
            return alert('‚ùå No hay campa√±as con datos para guardar');
        }

        try {
            // Buscar si ya existe un update para esta fecha
            const existing = await db.collection('dailyUpdates').where('date', '==', updateDate).get();
            
            if (!existing.empty) {
                // Ya existe un registro - FUSIONAR las campa√±as
                const existingDoc = existing.docs[0];
                const existingData = existingDoc.data();
                const existingCampaigns = existingData.campaigns || [];
                
                // Crear un mapa con las campa√±as existentes por campaignId
                const campaignMap = {};
                existingCampaigns.forEach(c => {
                    campaignMap[c.campaignId] = c;
                });
                
                // Actualizar o agregar las nuevas campa√±as
                campaignsWithData.forEach(c => {
                    campaignMap[c.campaignId] = c; // Sobrescribe si existe, agrega si no
                });
                
                // Convertir el mapa de vuelta a array
                const mergedCampaigns = Object.values(campaignMap);
                
                const entry = {
                    date: updateDate,
                    datetime: firebase.firestore.FieldValue.serverTimestamp(),
                    campaigns: mergedCampaigns
                };
                
                await db.collection('dailyUpdates').doc(existingDoc.id).update(entry);
                alert(`‚úÖ Actualizaci√≥n guardada\n${campaignsWithData.length} campa√±a(s) actualizada(s)\nTotal en el registro: ${mergedCampaigns.length} campa√±as\nFecha: ${updateDate}`);
            } else {
                // Crear nuevo registro
                const entry = {
                    date: updateDate,
                    datetime: firebase.firestore.FieldValue.serverTimestamp(),
                    campaigns: campaignsWithData
                };
                
                await db.collection('dailyUpdates').add(entry);
                alert(`‚úÖ Registro creado\n${campaignsWithData.length} campa√±a(s) guardada(s)\nFecha: ${updateDate}`);
            }

            // Limpiar solo las campa√±as que se guardaron
            const newTodayStatus = {...todayStatus};
            campaignsWithData.forEach(c => {
                delete newTodayStatus[c.campaignId];
            });
            setTodayStatus(newTodayStatus);
            
        } catch (error) {
            alert(`‚ùå Error al guardar: ${error.message}`);
        }
    };

    const generateMessage = () => {
        const date = new Date(updateDate).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        const cams = getUpdateCampaigns().filter(c => todayStatus[c.id]?.currentLeads || todayStatus[c.id]?.currentCPL || todayStatus[c.id]?.comment);
        if (cams.length === 0) return '(Sin datos)';
        
        return cams.map((c) => {
            const s = todayStatus[c.id] || {};
            let m = `Resumen campa√±a ${c.name}`;
            if (c.platform) m += ` - ${c.platform}`;
            m += ` - con corte a ${date}\n\n`;
            m += `* Objetivo: ${c.objective} leads\n`;
            if (c.plannedCPL) m += `* CPL planificado: ${c.plannedCPL} USD\n`;
            if (s.currentLeads) m += `* Avance: ${s.currentLeads} leads\n`;
            if (s.currentCPL) m += `* CPL actual: ${s.currentCPL} USD\n`;
            if (s.comment) m += `Comentario: ${s.comment}`;
            return m;
        }).join('\n\n');
    };

    const copyToClipboard = () => {
        const m = generateMessage();
        if (m.includes('Sin datos')) return alert('Agrega datos');
        navigator.clipboard.writeText(m);
        alert('Copiado');
    };

    const getFilteredCampaigns = () => selectedCampaign === 'all' ? campaigns : campaigns.filter(c => c.id === selectedCampaign);
    const getUpdateCampaigns = () => selectedUpdateCampaigns.length === 0 ? campaigns : campaigns.filter(c => selectedUpdateCampaigns.includes(c.id));
    
    const toggleCampaignSelection = (id) => {
        setSelectedUpdateCampaigns(selectedUpdateCampaigns.includes(id) ? selectedUpdateCampaigns.filter(x => x !== id) : [...selectedUpdateCampaigns, id]);
    };

    const getFilteredHistory = () => {
        let f = [...dailyUpdates];
        if (historyFilterPlatform !== 'all') {
            f = f.map(u => ({ ...u, campaigns: u.campaigns.filter(c => c.platform === historyFilterPlatform) })).filter(u => u.campaigns.length > 0);
        }
        if (historyFilterDateFrom) f = f.filter(u => u.date >= historyFilterDateFrom);
        if (historyFilterDateTo) f = f.filter(u => u.date <= historyFilterDateTo);
        return f;
    };

    const getUniquePlatforms = () => Array.from(new Set(campaigns.map(c => c.platform)));

    const getMonthlyStats = () => {
        const monthUpdates = dailyUpdates.filter(u => u.date && u.date.startsWith(selectedMonth));
        
        if (monthUpdates.length === 0) {
            // Mostrar mensaje de debug si no hay datos
            return { 
                totalLeads: 0, 
                totalObjective: 0, 
                progress: 0, 
                avgCPL: 0,
                debug: `No hay datos para ${selectedMonth}. Total de registros: ${dailyUpdates.length}`
            };
        }
        
        // Usar nombre de campa√±a como clave para agrupar
        const campaignTotals = {};
        
        monthUpdates.forEach(update => {
            if (!update.campaigns || !Array.isArray(update.campaigns)) {
                return;
            }
            
            update.campaigns.forEach(c => {
                const key = `${c.name}_${c.platform}`;
                
                if (!campaignTotals[key]) {
                    campaignTotals[key] = {
                        name: c.name,
                        maxLeads: 0,
                        objective: parseInt(c.objective) || 0,
                        totalSpend: 0,
                        lastCPL: 0
                    };
                }
                
                const leads = parseInt(c.currentLeads) || 0;
                const cpl = parseFloat(c.currentCPL) || 0;
                
                // Tomar el m√°ximo de leads
                if (leads > campaignTotals[key].maxLeads) {
                    campaignTotals[key].maxLeads = leads;
                    campaignTotals[key].lastCPL = cpl;
                }
            });
        });
        
        let totalLeads = 0;
        let totalObjective = 0;
        let totalSpend = 0;
        
        Object.values(campaignTotals).forEach(ct => {
            totalLeads += ct.maxLeads;
            totalObjective += ct.objective;
            if (ct.lastCPL > 0 && ct.maxLeads > 0) {
                totalSpend += (ct.lastCPL * ct.maxLeads);
            }
        });
        
        return {
            totalLeads,
            totalObjective,
            progress: totalObjective > 0 ? ((totalLeads / totalObjective) * 100).toFixed(1) : 0,
            avgCPL: totalLeads > 0 ? (totalSpend / totalLeads).toFixed(2) : 0
        };
    };

    const deleteUpdate = async (id) => {
        if (confirm('¬øEliminar este registro?')) {
            await db.collection('dailyUpdates').doc(id).delete();
        }
    };

    const loadUpdate = (u) => {
        const s = {};
        u.campaigns.forEach(c => {
            s[c.campaignId] = { currentLeads: c.currentLeads, currentCPL: c.currentCPL, comment: c.comment };
        });
        setTodayStatus(s);
        setUpdateDate(u.date);
        alert('Datos cargados para editar');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600 mb-4">Cargando datos...</div>
                    <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
            <div className="max-w-7xl mx-auto">
                <div className="text-center mb-6">
                    <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">STATUS CAMPA√ëAS VIAMAR</h1>
                    <div className="h-1 w-32 mx-auto bg-gradient-to-r from-blue-600 to-purple-600 rounded-full"></div>
                    <div className="mt-2 text-sm text-green-600 font-semibold">üîÑ Datos compartidos en tiempo real</div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div className="mb-4 flex items-center justify-between">
                        <div>
                            <label className="text-sm font-semibold text-gray-700 mr-3">Ver estad√≠sticas del mes:</label>
                            <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="px-4 py-2 border border-gray-300 rounded-lg bg-white font-medium">
                                <option value="2026-01">Enero 2026</option>
                                <option value="2025-12">Diciembre 2025</option>
                                <option value="2025-11">Noviembre 2025</option>
                                <option value="2025-10">Octubre 2025</option>
                                <option value="2025-09">Septiembre 2025</option>
                                <option value="2025-08">Agosto 2025</option>
                            </select>
                        </div>
                        <div className="text-sm text-gray-600">
                            Total registros: {dailyUpdates.length} | 
                            Para {selectedMonth}: {dailyUpdates.filter(u => u.date && u.date.startsWith(selectedMonth)).length}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                            <div className="text-sm opacity-90">Total Leads del Mes</div>
                            <div className="text-3xl font-bold">{getMonthlyStats().totalLeads}</div>
                            <div className="text-sm opacity-90">acumulados</div>
                        </div>
                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                            <div className="text-sm opacity-90">Objetivo del Mes</div>
                            <div className="text-3xl font-bold">{getMonthlyStats().totalObjective}</div>
                            <div className="text-sm opacity-90">leads</div>
                        </div>
                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                            <div className="text-sm opacity-90">Progreso Mensual</div>
                            <div className="text-3xl font-bold">{getMonthlyStats().progress}%</div>
                            <div className="text-sm opacity-90">del objetivo</div>
                        </div>
                        <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-4 text-white">
                            <div className="text-sm opacity-90">CPL Promedio Ponderado</div>
                            <div className="text-3xl font-bold">${getMonthlyStats().avgCPL}</div>
                            <div className="text-sm opacity-90">por lead</div>
                        </div>
                    </div>

                    {getMonthlyStats().debug && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                            ‚ö†Ô∏è {getMonthlyStats().debug}
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">Mis Campa√±as</h2>
                        <button onClick={() => setShowForm(!showForm)} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <Plus />Nueva Campa√±a
                        </button>
                    </div>

                    {showForm && (
                        <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" placeholder="Nombre" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="px-4 py-2 border rounded-lg"/>
                                <select value={formData.platform} onChange={(e) => setFormData({...formData, platform: e.target.value})} className="px-4 py-2 border rounded-lg">
                                    <option value="">Plataforma</option>
                                    <option value="Meta">Meta</option>
                                    <option value="Google PMAX">Google PMAX</option>
                                    <option value="Google B√∫squeda">Google B√∫squeda</option>
                                    <option value="Google Display">Google Display</option>
                                    <option value="Google Video">Google Video</option>
                                </select>
                                <input type="number" placeholder="Objetivo" value={formData.objective} onChange={(e) => setFormData({...formData, objective: e.target.value})} className="px-4 py-2 border rounded-lg"/>
                                <input type="number" step="0.01" placeholder="CPL USD" value={formData.plannedCPL} onChange={(e) => setFormData({...formData, plannedCPL: e.target.value})} className="px-4 py-2 border rounded-lg"/>
                            </div>
                            <div className="flex gap-2 mt-4">
                                <button onClick={handleAddCampaign} className="bg-blue-600 text-white px-6 py-2 rounded-lg">Agregar</button>
                                <button onClick={() => setShowForm(false)} className="bg-gray-300 px-6 py-2 rounded-lg">Cancelar</button>
                            </div>
                        </div>
                    )}

                    {campaigns.length > 0 ? (
                        <div>
                            <div className="mb-4 flex items-center gap-3">
                                <label className="text-sm font-semibold text-gray-700">Ver campa√±a:</label>
                                <select value={selectedCampaign} onChange={(e) => setSelectedCampaign(e.target.value)} className="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-2">
                                    <option value="all">Todas las campa√±as ({campaigns.length})</option>
                                    {campaigns.map(c => <option key={c.id} value={c.id}>{c.name} - {c.platform}</option>)}
                                </select>
                            </div>
                            
                            <div className="space-y-2">
                                {getFilteredCampaigns().map(c => (
                                    <div key={c.id} className="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                                        {editingCampaign?.id === c.id ? (
                                            <div className="flex-1 grid grid-cols-1 md:grid-cols-4 gap-2">
                                                <input type="text" value={editingCampaign.name} onChange={(e) => setEditingCampaign({...editingCampaign, name: e.target.value})} className="px-3 py-1 border rounded"/>
                                                <select value={editingCampaign.platform} onChange={(e) => setEditingCampaign({...editingCampaign, platform: e.target.value})} className="px-3 py-1 border rounded">
                                                    <option value="Meta">Meta</option>
                                                    <option value="Google PMAX">Google PMAX</option>
                                                    <option value="Google B√∫squeda">Google B√∫squeda</option>
                                                </select>
                                                <input type="number" value={editingCampaign.objective} onChange={(e) => setEditingCampaign({...editingCampaign, objective: e.target.value})} className="px-3 py-1 border rounded"/>
                                                <input type="number" step="0.01" value={editingCampaign.plannedCPL} onChange={(e) => setEditingCampaign({...editingCampaign, plannedCPL: e.target.value})} className="px-3 py-1 border rounded"/>
                                            </div>
                                        ) : (
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-semibold">{c.name}</span>
                                                    <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">{c.platform}</span>
                                                </div>
                                                <div className="text-sm text-gray-600">Objetivo: {c.objective} | CPL: ${c.plannedCPL || 'N/A'}</div>
                                            </div>
                                        )}
                                        <div className="flex gap-2">
                                            {editingCampaign?.id === c.id ? (
                                                <>
                                                    <button onClick={handleEditCampaign} className="text-green-600"><Save /></button>
                                                    <button onClick={() => setEditingCampaign(null)} className="text-gray-600"><X /></button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => setEditingCampaign(c)} className="text-blue-600"><Edit2 /></button>
                                                    <button onClick={() => handleDeleteCampaign(c.id)} className="text-red-500"><Trash2 /></button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-gray-500 py-8">
                            No hay campa√±as configuradas. Agrega tu primera campa√±a para comenzar.
                        </div>
                    )}
                </div>

                {campaigns.length > 0 && (
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-4">
                                <h2 className="text-2xl font-bold">Actualizaci√≥n</h2>
                                <input type="date" value={updateDate} onChange={(e) => setUpdateDate(e.target.value)} className="px-3 py-1 border rounded-lg"/>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={copyToClipboard} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg"><Copy />Copiar</button>
                                <button onClick={handleSaveDailyStatus} className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg"><Save />Guardar</button>
                            </div>
                        </div>

                        <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-4">
                            <div className="flex items-start gap-3 mb-3">
                                <div className="text-2xl">‚úÖ</div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-green-900 mb-1">Actualizaci√≥n por campa√±as</h3>
                                    <ul className="text-sm text-green-800 space-y-1">
                                        <li>‚úì Puedes actualizar una campa√±a a la vez</li>
                                        <li>‚úì Las campa√±as se van acumulando en el mismo d√≠a</li>
                                        <li>‚úì Si actualizas una campa√±a dos veces, se reemplaza solo esa campa√±a</li>
                                    </ul>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <label className="font-semibold text-gray-700">Selecciona campa√±a a actualizar:</label>
                                <select 
                                    onChange={(e) => {
                                        const val = e.target.value;
                                        if (val === 'all') {
                                            setSelectedUpdateCampaigns(campaigns.map(c => c.id));
                                        } else if (val === 'none') {
                                            setSelectedUpdateCampaigns([]);
                                        } else {
                                            setSelectedUpdateCampaigns([val]);
                                        }
                                    }}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white"
                                >
                                    <option value="all">Todas las campa√±as</option>
                                    <option value="none">Ninguna</option>
                                    {campaigns.map(c => (
                                        <option key={c.id} value={c.id}>{c.name} - {c.platform}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {getUpdateCampaigns().length === 0 && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                    <p className="text-yellow-800 font-semibold">‚ö†Ô∏è Ninguna campa√±a seleccionada para actualizar</p>
                                    <p className="text-sm text-yellow-600 mt-1">Selecciona "Todas las campa√±as" en el men√∫ de arriba</p>
                                </div>
                            )}
                            {getUpdateCampaigns().map(c => (
                                <div key={c.id} className="border rounded-lg p-4 bg-blue-50">
                                    <div className="flex items-center gap-2 mb-3">
                                        <h3 className="font-semibold text-lg">{c.name}</h3>
                                        <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">{c.platform}</span>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <input 
                                            type="number" 
                                            placeholder="Leads" 
                                            value={todayStatus[c.id]?.currentLeads || ''} 
                                            onChange={(e) => handleStatusChange(c.id, 'currentLeads', e.target.value)} 
                                            className="px-3 py-2 border rounded-lg"
                                        />
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            placeholder="CPL USD" 
                                            value={todayStatus[c.id]?.currentCPL || ''} 
                                            onChange={(e) => handleStatusChange(c.id, 'currentCPL', e.target.value)} 
                                            className="px-3 py-2 border rounded-lg"
                                        />
                                        <input 
                                            type="text" 
                                            placeholder="Comentario" 
                                            value={todayStatus[c.id]?.comment || ''} 
                                            onChange={(e) => handleStatusChange(c.id, 'comment', e.target.value)} 
                                            className="px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    {(todayStatus[c.id]?.currentLeads || todayStatus[c.id]?.currentCPL || todayStatus[c.id]?.comment) && (
                                        <div className="mt-2 text-xs text-green-600 font-semibold">‚úì Esta campa√±a tiene datos y se guardar√°</div>
                                    )}
                                </div>
                            ))}
                            <div className="bg-gray-100 rounded-lg p-3 text-sm">
                                <strong>Total de campa√±as visibles:</strong> {getUpdateCampaigns().length} | 
                                <strong className="ml-2">Con datos para guardar:</strong> {Object.keys(todayStatus).filter(id => todayStatus[id]?.currentLeads || todayStatus[id]?.currentCPL || todayStatus[id]?.comment).length}
                            </div>
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4 mt-6">
                            <h3 className="font-semibold text-lg mb-3">Preview</h3>
                            <pre className="whitespace-pre-wrap text-sm bg-white p-4 rounded border">{generateMessage()}</pre>
                        </div>
                    </div>
                )}

                {dailyUpdates.length > 0 && (
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-2xl font-bold mb-4">Historial</h2>
                        
                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <select value={historyFilterPlatform} onChange={(e) => setHistoryFilterPlatform(e.target.value)} className="px-3 py-2 border rounded-lg">
                                    <option value="all">Todas las plataformas</option>
                                    {getUniquePlatforms().map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                                <input type="date" value={historyFilterDateFrom} onChange={(e) => setHistoryFilterDateFrom(e.target.value)} className="px-3 py-2 border rounded-lg" placeholder="Desde"/>
                                <input type="date" value={historyFilterDateTo} onChange={(e) => setHistoryFilterDateTo(e.target.value)} className="px-3 py-2 border rounded-lg" placeholder="Hasta"/>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {getFilteredHistory().map(u => {
                                const tl = u.campaigns.reduce((s, c) => s + (parseInt(c.currentLeads) || 0), 0);
                                const to = u.campaigns.reduce((s, c) => s + (parseInt(c.objective) || 0), 0);
                                const p = to > 0 ? ((tl / to) * 100).toFixed(1) : 0;
                                
                                return (
                                    <div key={u.id} className="border-2 rounded-xl p-5 bg-gradient-to-r from-white to-gray-50">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <Calendar />
                                                    <span className="font-bold text-xl">{new Date(u.date).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</span>
                                                </div>
                                                <div className="flex gap-4 text-sm">
                                                    <span>{u.campaigns.length} campa√±as</span>
                                                    <span>Total: <strong className="text-blue-600">{tl}</strong> de {to}</span>
                                                    <span>Progreso: <strong className="text-green-600">{p}%</strong></span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => loadUpdate(u)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 /></button>
                                                <button onClick={() => deleteUpdate(u.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 /></button>
                                            </div>
                                        </div>

                                        <div className="mb-4">
                                            <div className="w-full bg-gray-200 rounded-full h-3">
                                                <div className="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full" style={{width: `${Math.min(p, 100)}%`}}></div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {u.campaigns.map((c, i) => {
                                                const cp = c.objective > 0 ? ((parseInt(c.currentLeads) || 0) / parseInt(c.objective) * 100).toFixed(0) : 0;
                                                return (
                                                    <div key={i} className="bg-white rounded-lg p-4 border hover:border-blue-300 shadow-sm">
                                                        <div className="flex justify-between mb-2">
                                                            <div className="flex-1">
                                                                <div className="font-semibold truncate">{c.name}</div>
                                                                <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">{c.platform}</span>
                                                            </div>
                                                            <div className="text-2xl font-bold text-blue-600">{cp}%</div>
                                                        </div>
                                                        {c.currentLeads && (
                                                            <div className="mt-3">
                                                                <div className="flex justify-between text-sm mb-1">
                                                                    <span>Leads</span>
                                                                    <span className="font-semibold">{c.currentLeads}/{c.objective}</span>
                                                                </div>
                                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                                    <div className="bg-blue-500 h-2 rounded-full" style={{width: `${Math.min(cp, 100)}%`}}></div>
                                                                </div>
                                                            </div>
                                                        )}
                                                        {c.currentCPL && <div className="mt-2 text-sm flex justify-between"><span>CPL:</span><span className="font-semibold text-green-600">${c.currentCPL}</span></div>}
                                                        {c.comment && <div className="mt-2 pt-2 border-t text-xs text-gray-600 italic">{c.comment}</div>}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
