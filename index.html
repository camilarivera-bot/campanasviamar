<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Campañas Viamar</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCdH7SDkxWHKRnCIiueEkr5PUOOqmZO_1k",
  authDomain: "campanas-viamar.firebaseapp.com",
  projectId: "campanas-viamar",
  storageBucket: "campanas-viamar.firebasestorage.app",
  messagingSenderId: "165190287506",
  appId: "1:165190287506:web:7fc6f39401a136d4a7e64b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>;
const Copy = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
const Save = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
const Calendar = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
const X = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

const App = () => {
    const [campaigns, setCampaigns] = useState([]);
    const [dailyUpdates, setDailyUpdates] = useState([]);
    const [showForm, setShowForm] = useState(false);
    const [editingCampaign, setEditingCampaign] = useState(null);
    const [todayStatus, setTodayStatus] = useState({});
    const [updateDate, setUpdateDate] = useState(new Date().toISOString().split('T')[0]);
    const [selectedCampaign, setSelectedCampaign] = useState('all');
    const [selectedUpdateCampaigns, setSelectedUpdateCampaigns] = useState([]);
    const [historyFilterPlatform, setHistoryFilterPlatform] = useState('all');
    const [historyFilterDateFrom, setHistoryFilterDateFrom] = useState('');
    const [historyFilterDateTo, setHistoryFilterDateTo] = useState('');
    const [selectedMonth, setSelectedMonth] = useState('2025-01');
    const [formData, setFormData] = useState({ name: '', platform: '', objective: '', plannedCPL: '' });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsubscribeCampaigns = db.collection('campaigns').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCampaigns(data);
            setLoading(false);
        });

        const unsubscribeUpdates = db.collection('dailyUpdates').orderBy('date', 'desc').onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDailyUpdates(data);
        });

        return () => {
            unsubscribeCampaigns();
            unsubscribeUpdates();
        };
    }, []);

    useEffect(() => {
        if (campaigns.length > 0 && selectedUpdateCampaigns.length === 0) {
            setSelectedUpdateCampaigns(campaigns.map(c => c.id.toString()));
        }
    }, [campaigns]);

    const handleAddCampaign = async () => {
        if (formData.name && formData.objective && formData.platform) {
            await db.collection('campaigns').add({
                ...formData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setFormData({ name: '', platform: '', objective: '', plannedCPL: '' });
            setShowForm(false);
        }
    };

    const handleEditCampaign = async () => {
        if (editingCampaign) {
            await db.collection('campaigns').doc(editingCampaign.id).update({
                name: editingCampaign.name,
                platform: editingCampaign.platform,
                objective: editingCampaign.objective,
                plannedCPL: editingCampaign.plannedCPL
            });
            setEditingCampaign(null);
        }
    };

    const handleDeleteCampaign = async (id) => {
        if (confirm('¿Eliminar campaña?')) {
            await db.collection('campaigns').doc(id).delete();
        }
    };

    const handleStatusChange = (id, field, value) => {
        setTodayStatus({ ...todayStatus, [id]: { ...todayStatus[id], [field]: value } });
    };

    const handleSaveDailyStatus = async () => {
        const hasData = Object.keys(todayStatus).some(id => todayStatus[id]?.currentLeads || todayStatus[id]?.currentCPL || todayStatus[id]?.comment);
        if (!hasData) return alert('Agrega datos');

        const entry = {
            date: updateDate,
            datetime: firebase.firestore.FieldValue.serverTimestamp(),
            campaigns: campaigns.map(c => ({
                campaignId: c.id,
                name: c.name,
                platform: c.platform,
                objective: c.objective,
                plannedCPL: c.plannedCPL,
                currentLeads: todayStatus[c.id]?.currentLeads || '',
                currentCPL: todayStatus[c.id]?.currentCPL || '',
                comment: todayStatus[c.id]?.comment || ''
            })).filter(c => c.currentLeads || c.currentCPL || c.comment)
        };

        const existing = await db.collection('dailyUpdates').where('date', '==', updateDate).get();
        
        if (!existing.empty) {
            await db.collection('dailyUpdates').doc(existing.docs[0].id).update(entry);
        } else {
            await db.collection('dailyUpdates').add(entry);
        }

        setTodayStatus({});
        alert('Guardado exitosamente');
    };

    const generateMessage = () => {
        const date = new Date(updateDate).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        const cams = getUpdateCampaigns().filter(c => todayStatus[c.id]?.currentLeads || todayStatus[c.id]?.currentCPL || todayStatus[c.id]?.comment);
        if (cams.length === 0) return '(Sin datos)';
        
        return cams.map((c) => {
            const s = todayStatus[c.id] || {};
            let m = `Resumen campaña ${c.name}`;
            if (c.platform) m += ` - ${c.platform}`;
            m += ` - con corte a ${date}\n\n`;
            m += `* Objetivo: ${c.objective} leads\n`;
            if (c.plannedCPL) m += `* CPL planificado: ${c.plannedCPL} USD\n`;
            if (s.currentLeads) m += `* Avance: ${s.currentLeads} leads\n`;
            if (s.currentCPL) m += `* CPL actual: ${s.currentCPL} USD\n`;
            if (s.comment) m += `Comentario: ${s.comment}`;
            return m;
        }).join('\n\n');
    };

    const copyToClipboard = () => {
        const m = generateMessage();
        if (m.includes('Sin datos')) return alert('Agrega datos');
        navigator.clipboard.writeText(m);
        alert('Copiado');
    };

    const getFilteredCampaigns = () => selectedCampaign === 'all' ? campaigns : campaigns.filter(c => c.id === selectedCampaign);
    const getUpdateCampaigns = () => selectedUpdateCampaigns.length === 0 ? campaigns : campaigns.filter(c => selectedUpdateCampaigns.includes(c.id));
    
    const toggleCampaignSelection = (id) => {
        setSelectedUpdateCampaigns(selectedUpdateCampaigns.includes(id) ? selectedUpdateCampaigns.filter(x => x !== id) : [...selectedUpdateCampaigns, id]);
    };

    const getFilteredHistory = () => {
        let f = [...dailyUpdates];
        if (historyFilterPlatform !== 'all') {
            f = f.map(u => ({ ...u, campaigns: u.campaigns.filter(c => c.platform === historyFilterPlatform) })).filter(u => u.campaigns.length > 0);
        }
        if (historyFilterDateFrom) f = f.filter(u => u.date >= historyFilterDateFrom);
        if (historyFilterDateTo) f = f.filter(u => u.date <= historyFilterDateTo);
        return f;
    };

    const getUniquePlatforms = () => Array.from(new Set(campaigns.map(c => c.platform)));

    const getMonthlyStats = () => {
        const monthUpdates = dailyUpdates.filter(u => u.date && u.date.startsWith(selectedMonth));
        
        if (monthUpdates.length === 0) return { totalLeads: 0, totalObjective: 0, progress: 0, avgCPL: 0 };
        
        const campaignTotals = {};
        
        monthUpdates.forEach(update => {
            update.campaigns.forEach(c => {
                if (!campaignTotals[c.campaignId]) {
                    campaignTotals[c.campaignId] = {
                        maxLeads: 0,
                        objective: parseInt(c.objective) || 0,
                        totalSpend: 0,
                        lastCPL: 0
                    };
                }
                
                const leads = parseInt(c.currentLeads) || 0;
                const cpl = parseFloat(c.currentCPL) || 0;
                
                if (leads > campaignTotals[c.campaignId].maxLeads) {
                    campaignTotals[c.campaignId].maxLeads = leads;
                    campaignTotals[c.campaignId].lastCPL = cpl;
                }
            });
        });
        
        let totalLeads = 0;
        let totalObjective = 0;
        let totalSpend = 0;
        
        Object.values(campaignTotals).forEach(ct => {
            totalLeads += ct.maxLeads;
            totalObjective += ct.objective;
            if (ct.lastCPL > 0 && ct.maxLeads > 0) {
                totalSpend += (ct.lastCPL * ct.maxLeads);
            }
        });
        
        return {
            totalLeads,
            totalObjective,
            progress: totalObjective > 0 ? ((totalLeads / totalObjective) * 100).toFixed(1) : 0,
            avgCPL: totalLeads > 0 ? (totalSpend / totalLeads).toFixed(2) : 0
        };
    };

    const deleteUpdate = async (id) => {
        if (confirm('¿Eliminar este registro?')) {
            await db.collection('dailyUpdates').doc(id).delete();
        }
    };

    const loadUpdate = (u) => {
        const s = {};
        u.campaigns.forEach(c => {
            s[c.campaignId] = { currentLeads: c.currentLeads, currentCPL: c.currentCPL, comment: c.comment };
        });
        setTodayStatus(s);
        setUpdateDate(u.date);
        alert('Datos cargados para editar');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600 mb-4">Cargando datos...</div>
                    <div className="animate-spin rounded-full h-16 w-16 bor
